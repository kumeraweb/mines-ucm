---
import '../styles/global.css'
import { SITE } from '../data/site'
import FloatingWhatsApp from '../components/FloatingWhatsApp.astro'
import PromoModal from '../components/PromoModal.astro'

// Normalizamos canonical
const canonical = SITE.domain.replace(/\/+$/, '')

// Títulos y descripciones sanitizadas
const defaultTitle = SITE.title || `Contrata tu Plan UCM con ${SITE.name}`
const defaultDescription =
  SITE.description ||
  `Afíliate a UCM con ejecutiva autorizada. Asesoría para contratar tu plan UCM en ${SITE.city}. Cotiza hoy por WhatsApp.`

const title = Astro.props.title ?? defaultTitle
const description = Astro.props.description ?? defaultDescription
const image = Astro.props.image ?? SITE.ogImage
const ogImageUrl = `${canonical}${image}`
---

<!doctype html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- SEO -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta
      name="keywords"
      content={`planes UCM, contratar plan UCM, ejecutiva ${SITE.name}, afiliación UCM, asesoría UCM, cotizar plan UCM`}
    />

    <!-- CANONICAL -->
    <link rel="canonical" href={canonical} />

    <!-- OG -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:url" content={canonical} />
    <meta property="og:locale" content="es_CL" />

    <!-- TWITTER -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />

    <link rel="icon" href="/faviconb.png" />
    <link rel="preload" href={image} as="image" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17742112944"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'AW-17742112944');
    </script>

    <!-- TRACKING CTA (versión segura) -->
    <script is:inline>
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("[data-cta]")?.forEach((el) => {
          el.addEventListener("click", () => {
            const id = el.getAttribute("data-cta");

            gtag("event", "cta_click", { id });

            if (id === "whatsapp") {
              gtag("event", "conversion", {
                send_to: "AW-17742112944/A7elCNefzMIbELDRjIxC",
                value: 1.0,
                currency: "CLP",
              });
            }

            if (id === "llamar" || id === "call") {
              gtag("event", "conversion", {
                send_to: "AW-17742112944/gseqCNqfzMIbELDRjIxC",
                value: 1.0,
                currency: "CLP",
              });
            }

            if (id === "formulario") {
              gtag("event", "conversion", {
                send_to: "AW-17545387254/xxxxFORMxxxx",
                value: 1.0,
                currency: "CLP",
              });
            }
          });
        });
      });
    </script>


    <!-- SCHEMA ORG SEGURO -->
    <script type="application/ld+json" is:inline>
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "LocalBusiness",
        "@businessType": "Consulting",
        name: `Ejecutiva UCM - ${SITE.name}`,
        url: canonical,
        logo: `${canonical}/favicon.png`,
        image: ogImageUrl,
        description,
        areaServed: ["Santiago", "Valparaíso"],
        contactPoint: {
          "@type": "ContactPoint",
          telephone: `+56${SITE.phone}`,
          contactType: "customer support",
          availableLanguage: ["Spanish"],
          email: SITE.email
        }
      })}
    </script>
  </head>

  <body class="text-gray-900 antialiased bg-white">
    <slot />
    <FloatingWhatsApp />
    <!-- <PromoModal /> -->
  </body>
</html>
